<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Listado de Terrenos</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- 游눠 CARD DE RESUMEN AGREGADA: Muestra el total de terrenos y la superficie global -->
  <ion-card class="ion-margin-top ion-margin-horizontal custom-summary-card">
    <ion-grid>
      <ion-row class="ion-align-items-center ion-padding-vertical">

        <!-- Conteo de Terrenos -->
        <ion-col size="6" class="ion-text-center ion-padding-end ion-border-right">
          <p class="summary-label ion-no-margin">Total de Terrenos</p>
          <!-- Usa la se침al terrenos() para contar el n칰mero de elementos -->
          <h2 class="summary-value ion-no-margin">{{ terrenoService.terrenos().length }}</h2>
        </ion-col>

        <!-- Superficie Total Global -->
        <ion-col size="6" class="ion-text-center ion-padding-start">
          <p class="summary-label ion-no-margin">Superficie Total (M)</p>
          <!-- Usa la se침al totalSuperficieGlobal() para el c치lculo total -->
          <!-- <h2 class="summary-value ion-no-margin">{{ totalSuperficieGlobal() || 0 }}</h2> -->
        </ion-col>

      </ion-row>
    </ion-grid>
  </ion-card>
  <!-- FIN DE LA CARD DE RESUMEN -->

  <!-- Utilizamos ion-accordion-group para crear la vista de 치rbol colapsable -->
  <ion-accordion-group expand="inset">

    @for (terreno of terrenoService.terrenos(); track terreno.terrenoUuid) {
    <ion-accordion value="terreno-{{ terreno.terrenoUuid }}">

      <!-- ENCABEZADO (HEADER): Muestra la info principal. El 'button' ya no est치. -->
      <!-- Usamos toggle-icon="default" para que el acorde칩n maneje el 칤cono de expansi칩n. -->
      <ion-item slot="header" toggle-icon="default" class="ion-no-padding">
        <!-- <ion-icon name="map-outline" slot="start" color="primary" class="ion-padding-start"></ion-icon> -->
        <ion-label class="ion-text-wrap ion-padding-vertical">
          <h3>Terreno No. {{ terreno.terrenoNo || '(sin n칰mero)' }}</h3>
          <p>{{ catalogoService.getDescripcionByCodigo(terreno.accesoTierra)() }}-{{
            catalogoService.getDescripcionByCodigo(terreno.coberturaTierra)() }}</p>
        </ion-label>
        <ion-text slot="end" class="ion-text-right ion-padding-end">
          <span class="superficie-text">{{ getSuperficieTerrenoEnM2(terreno) | number:'1.2-2' }}
            M</span>
        </ion-text>

        <!-- Bot칩n de NAVEGACI칍N (B0102): Colocamos la navegaci칩n en un bot칩n expl칤cito -->
        <ion-buttons slot="end">
          <ion-button fill="clear" color="primary"
            (click)="selectTerreno(terreno.terrenoUuid); $event.stopPropagation()">
            <ion-icon name="create-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-item>

      <!-- CONTENIDO (CONTENT): Los hijos del 치rbol (Cultivos y Cultivos Forestales) -->
      <!-- ESTE CONTENIDO SE MUESTRA AL EXPANDIR EL ACORDE칍N -->
      <div slot="content" class="ion-no-padding">
        <ion-list lines="full">
          @for (cultivo of terreno.cultivos; track cultivo.cultivoUuid) {

          <!-- Opci칩n para ir a la pantalla de Cultivos (B0301) -->
          <ion-item button detail class="sub-tabla-item"
            (click)="navegarACultivo(terreno.terrenoUuid, cultivo.cultivoUuid)">
            <!-- <ion-icon name="leaf-outline" slot="start"
              [color]="terreno.isCultivoEnTerrenos ? 'success' : 'medium'"></ion-icon> -->
            <ion-label>
              <h4>Cultivos</h4>
              <p [class.text-green]="terreno.isCultivoEnTerrenos">
                {{ terreno.isCultivoEnTerrenos ? terreno.cultivos.length + ' Cultivo(s) registrado(s)' : 'Sin registros'
                }}
              </p>
            </ion-label>
            <!-- >>> C칍DIGO AGREGADO PARA SUPERFICIE DE CULTIVOS (L칤neas 101-110) >>> -->
            <!-- INSERCI칍N DE SUPERFICIE PLANTADA  DE CULTIVOS -->
            <ion-text slot="end" class="ion-text-right ion-no-padding superficie-resumen">
              <p class="ion-no-margin resumen-line superficie-resumen-valor">
                Plantada: {{
                getSuperficieResumenCultivo(terreno).plantada | number:'1.2-2' }} M
              </p>
            </ion-text>
            <!-- <<< FIN DEL C칍DIGO AGREGADO PARA SUPERFICIE DE CULTIVOS <<< -->
          </ion-item>
          }
          <!-- Opci칩n para ir a la pantalla de Cultivos Forestales (B0302) -->
          @for (forestales of terreno.cultivosForestales; track forestales.forestalUuid) {
          <ion-item button detail class="sub-tabla-item"
            (click)="navegarAForestal(terreno.terrenoUuid, forestales.forestalUuid)">
            <!-- <ion-icon name="tree-outline" slot="start"
              [color]="terreno.isPoseeEspeciesForestales ? 'success' : 'medium'"></ion-icon> -->
            <ion-label>
              <h4>Cultivos Forestales</h4>
              <p [class.text-green]="terreno.isPoseeEspeciesForestales">
                {{ terreno.isPoseeEspeciesForestales ? terreno.cultivosForestales.length + ' Especie(s) registrada(s)' :
                'Sin registros' }}
              </p>
            </ion-label>
            <!-- >>> C칍DIGO AGREGADO PARA SUPERFICIE FORESTAL (L칤neas 125-131) >>> -->
            <!-- INSERCI칍N DE SUPERFICIE PLANTADA FORESTAL -->

            <!-- Nota: Se utiliza un solo bloque de p para "superficie plantada" seg칰n la referencia visual. -->
            <ion-text slot="end" class="ion-text-right ion-no-padding superficie-resumen">
              <p class="ion-no-margin resumen-line superficie-resumen-valor">
                Plantada: {{
                getSuperficieResumenForestal(terreno).plantada | number:'1.2-2' }} M
              </p>
            </ion-text>
            <!-- <<< FIN DEL C칍DIGO AGREGADO PARA SUPERFICIE FORESTAL <<< -->
          </ion-item>
          }

        </ion-list>
      </div>
    </ion-accordion>

    <!-- Divisor visual entre terrenos si se requiere -->
    <div class="ion-margin-bottom"></div>

    } @empty {
    <ion-item>
      <ion-label>No hay terrenos registrados.</ion-label>
    </ion-item>
    }
  </ion-accordion-group>
</ion-content>